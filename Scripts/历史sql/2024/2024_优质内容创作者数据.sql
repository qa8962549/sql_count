-- 优质内容创作者数据信息
select
-- tmi.USER_ID,
-- IFNULL(tmi.REAL_NAME,tmi.MEMBER_NAME) "姓名",
tmi.ID "会员ID",
-- tmi.MEMBER_URL "会员头像",
case when tmi.IS_VEHICLE='1' then '车主'
	else '粉丝' end 是否车主,
b.LEVEL_NAME 会员等级,
tmi.MEMBER_PHONE "手机号",
t.车型,
t.VIN,
x.city 城市,
-- tr.REGION_NAME 城市,
-- tisd.dealer_code 经销商代码,
--'' 车主标签IP,
ifnull(x4.粉丝数,0) 粉丝数,
ifnull(x1.发帖量,0) 发帖量,
ifnull(x2.被加精帖子数,0)被加精帖子数,
ifnull(x3.上推荐帖子数,0)上推荐帖子数
-- tc.CODE_CN_DESC "性别",
-- tmi.MEMBER_BIRTHDAY "生日",
-- tmi.MEMBER_HOBBY "爱好兴趣"
from `member`.tc_member_info tmi 
left join (
	select t.*
	from (
		-- 用户最新绑车
		 select
		 r.member_id,
		 r.vin_code VIN,
		 m.member_phone ,
		 tm.model_name 车型,
		 r.bind_date,
		 row_number() over(partition by r.member_id order by r.bind_date desc) rk
		 from volvo_cms.vehicle_bind_relation r
		 left join "member".tc_member_info m on m.id =r.member_id 
		 left join vehicle.tt_invoice_statistics_dms d on r.vin_code = d.vin and d.is_deleted = 0
		 left join vehicle.tm_vehicle tv on r.vin_code = tv.vin and tv.is_deleted = 0
		 left join basic_data.tm_model tm on ifnull(d.model_id,tv.model_id) = tm.id and tm.is_deleted = 0
		 where r.deleted = 0
	--	 and m.member_phone ='19871064587'
		 and r.is_bind = 1)t where t.rk=1
		 )t on t.member_id=tmi.id
left join (
	select 
	a.member_id
	,count(a.id) 发帖量
	from community.tm_post a
	where a.is_deleted =0
	group by 1
	)x1 on x1.member_id=tmi.id
left join (
	select 
	a.member_id
	,count(a.id) 被加精帖子数
	from community.tm_post a
	where a.is_deleted =0
	and a.selected_time>0
	group by 1
	)x2 on x2.member_id=tmi.id
left join (
	select 
	a.member_id
	,count(a.id) 上推荐帖子数
	from community.tm_post a
	where a.is_deleted =0
	and a.recommend=1
	group by 1
	)x3 on x3.member_id=tmi.id
left join 
	(select a.member_id,count(1) 粉丝数
	from mine.tt_fans_relationship a
	where a.is_deleted =0
--	and a.create_time <'2023-05-08'
	group by 1
	)x4 on x4.member_id=tmi.id
left join dictionary.tc_code tc on tc.CODE_ID =tmi.MEMBER_SEX
left join dictionary.tc_region tr on tmi.MEMBER_PROVINCE = tr.REGION_CODE
left join vehicle.tt_invoice_statistics_dms tisd on t.VIN = tisd.vin 
left join 
(
	-- 会员等级表，这里需要剔除重复的会员等级
	select
	distinct b.LEVEL_CODE,
	b.LEVEL_NAME
	from `member`.tc_level b
	where b.LEVEL_CODE is not null
	order by 1
) b on tmi.LEVEL_ID = b.LEVEL_CODE
	left join (
	select m.id
	,m.member_phone 
	,ifnull(c1.region_name,IFNULL(c2.region_name,c3.region_name)) city 
	from member.tc_member_info m 
	left join (
	 select a.member_id,c.city_name region_name-- ,a.model_name
	 from (
	  select v.member_id,ifnull(d.dealer_code,vv.dealer_code) dealer_code,vv.model_name
	  from (
	    select v.MEMBER_ID,v.VIN
	    ,row_number() over(partition by v.MEMBER_ID order by v.create_time desc) rk
	    from member.tc_member_vehicle v 
	    where v.is_deleted=0 and v.MEMBER_ID is not null
	  ) v
	  left join vehicle.tm_vehicle vv on v.vin =vv.vin and vv.IS_DELETED=0
	  left join vehicle.tt_invoice_statistics_dms d on v.vin=d.vin and d.IS_DELETED=0
	  left join member.tc_member_info m  on v.member_id=m.id
	  where v.rk=1 -- 获取用户最后绑车记录
	 ) a left join organization.tm_company c on c.company_code=a.dealer_code and c.COMPANY_TYPE=15061003
	) c1 on c1.member_id = m.id
	left join (
	 select m.id,c.REGION_NAME
	 from member.tc_member_info m  
	 left join dictionary.tc_region c on m.member_city=c.REGION_ID
	 where m.IS_DELETED=0 and m.MEMBER_STATUS<>60341003
	) c2 on c2.id= m.id
	left join (
	 select m.id,cc.REGION_NAME
	 from member.tc_member_info m 
	 left join member.tc_member_address a on m.id::varchar=a.member_id::varchar and a.IS_DEFAULT=1 and a.status=0
	 left join dictionary.tc_region cc on a.ADDRESS_CITY::varchar=cc.REGION_ID::varchar
	 where m.IS_DELETED=0 and m.MEMBER_STATUS<>60341003
	) c3 on c3.id= m.id
	where m.MEMBER_STATUS<>60341003 
	and m.IS_DELETED=0 )x on x.id=tmi.id
where tmi.IS_DELETED =0 
and tmi.MEMBER_STATUS <>60341003 
and tmi.id in ('3831581',
'6275799',
'3214557',
'4563537',
'4784984',
'4800301',
'5704342',
'4441765',
'3561555',
'5888172',
'5784019',
'6119108',
'3048571',
'4181856',
'3245818',
'3345682',
'3372047',
'3757922',
'5247014',
'5508291',
'4159383',
'5272243',
'5483422',
'6119923',
'3309080',
'4064023',
'4186308',
'4620091',
'3408495',
'4197346',
'4719602',
'5272696',
'5564141',
'6381724',
'6535245',
'3081573',
'3685575',
'3556414',
'3557378',
'3563301',
'3630544',
'4126645',
'4231713',
'4266927',
'4604927',
'5534170',
'5670716',
'5708492',
'6063057',
'3587778',
'3699562',
'4770529',
'5620008',
'5857590',
'5908282',
'5965613',
'6073882',
'6423057',
'4256572',
'3042183',
'3050529',
'3165261',
'3170680',
'3231269',
'3405677',
'3673829',
'3687485',
'4189039',
'4189686',
'4300436',
'4340367',
'4375251',
'4411294',
'4459798',
'5559509',
'5566850',
'5578509',
'5708496',
'5735887',
'6361259',
'3018468',
'3020766',
'3207376',
'3311366',
'3349169',
'3490879',
'3589183',
'3613190',
'4248864',
'4261642',
'4645502',
'4719391',
'4806858',
'5372278',
'5554537',
'5878876',
'5911070',
'6054591',
'6061068',
'6075425',
'3076672',
'3113479',
'3242249',
'3265787',
'3355830',
'3506250',
'3509211',
'3593518',
'3614752',
'3705678',
'3722040',
'3815307',
'4092961',
'4167554',
'4238701',
'4240436',
'4360109',
'4413775',
'4428600',
'4438847',
'4542963',
'4557250',
'4575571',
'4619844',
'4736674',
'5281278',
'5395482',
'5508033',
'5516877',
'5546494',
'5553883',
'5589965',
'5615823',
'5666236',
'5678593',
'5695323',
'5705413',
'5735219',
'5801950',
'5823508',
'5905646',
'6007846',
'6075827',
'6083507',
'6104127',
'6115545',
'6176662',
'6203725',
'6217339',
'6219352',
'6229061',
'6376299',
'6405833',
'6689296',
'6774978',
'3307627',
'6080935',
'5949646',
'5762053',
'5276784',
'4366066',
'5889331',
'6059152',
'3501510',
'3646015',
'5261422',
'5514084',
'6052736',
'6384269',
'3565931',
'5377693',
'5600911',
'5787240',
'6159916',
'6344868',
'5983212',
'6840724',
'6770021',
'6732851',
'6367915',
'6131891',
'6646516',
'6071136',
'5847736',
'6063515',
'7055447',
'5765610',
'5650251',
'6066215',
'6186174',
'5587608',
'3806683',
'3684450',
'4534538',
'5516692',
'6399691',
'3213721',
'4736623',
'3113643',
'5850204',
'3723442',
'5762330',
'3715178',
'4092740',
'5550781',
'5559179',
'5259353',
'3594240',
'6450868',
'7096911',
'6127301',
'3525309',
'5861012',
'3940470',
'5501230',
'3372996',
'5544657',
'7251567',
'5801241',
'3896207',
'5493845',
'6777817',
'7239302',
'5263056',
'3020265',
'4275322',
'3862005',
'5988658',
'4299895',
'4723407',
'6007472',
'6165256',
'5760316',
'6694698',
'6391227',
'3405766',
'7071943',
'4767262',
'3427253',
'4443180',
'5292619',
'4093371',
'5764201',
'4785741',
'3805686',
'5668543',
'6597961',
'5889024',
'4467006',
'5651852',
'6462459',
'4384743',
'5880975',
'6719718',
'4147887',
'5973741',
'5834070',
'5874431',
'6055857',
'6630062',
'4737379',
'3639685',
'3606210',
'3024695',
'6008189',
'7355743',
'3601819',
'7254628',
'5954731',
'4285255',
'3829183',
'5923224',
'4562016',
'4771579',
'5269910',
'7104649',
'4729565',
'5640109',
'6353181',
'3716647',
'4741932',
'3042212',
'6804849',
'5368414',
'5494172',
'3717910',
'6489969',
'5510635',
'6177509',
'5596741',
'5709896',
'7137323',
'7754852',
'3042253',
'7430734',
'5981523',
'6094494',
'5271677',
'5564004',
'3838309',
'3929460',
'4585806',
'7408686',
'5773878',
'7706090',
'4092954',
'3177594',
'3678399',
'5814910',
'3152589',
'6014659',
'5608878',
'7065622',
'5972007',
'3690487',
'6490957',
'6089091',
'3244479',
'4304294',
'4255607',
'3690487',
'3762552',
'5644434',
'5641963',
'3741728',
'6357910',
'7677072',
'3676773',
'6065325',
'3484281',
'3109137',
'5561695',
'6649484',
'4559595',
'5544365',
'5822609',
'6164088',
'4274362',
'3678038',
'6341221',
'5253392',
'3249150',
'4809435',
'5447242',
'6059602',
'7121879',
'4802817',
'5659176',
'5717487',
'6119560',
'7355536',
'5979720',
'5515575',
'7895582',
'7357123',
'3823652',
'5677908',
'6119566',
'3297946',
'6214797',
'5378330',
'3265468',
'3509293',
'5757692',
'4194678',
'6670323',
'7698165',
'6879154',
'5678946',
'5903782',
'3552104',
'5253543',
'5365672',
'5363667',
'8171884',
'3057338',
'4223730',
'7240456')


select a.member_id,count(1)
from mine.tt_fans_relationship a
where a.is_deleted =0
and a.create_time <'2023-05-08'
and a.member_id in ('3048571',
'5784019',
'5508291',
'5566850',
'4159383',
'4261642',
'4777311',
'3415965',
'5670716',
'4126645',
'3410297',
'5857590',
'5269799',
'5853400',
'3214557',
'5272243',
'3714985',
'3815307',
'5798839',
'4563537',
'4189039',
'3307627',
'5987758',
'4427819',
'5503006',
'4398924',
'3561555',
'4468395',
'6016274',
'4784984',
'5534170',
'3405677',
'5954849',
'3805686',
'3408495',
'3588639',
'5337915',
'3152209',
'4317385',
'5600068',
'3018468',
'4813398',
'4248864',
'6115545',
'3245818',
'4231713',
'3627123',
'3587778',
'5340366',
'6055998',
'3685575',
'3722040',
'5587949',
'4658183',
'4542963',
'3831581',
'3687485',
'4167554',
'5564141',
'5247014',
'4440915',
'4252885',
'4242332',
'4428600',
'4459798',
'4413775',
'6013306',
'3757922',
'4256572',
'3131890',
'6130648',
'3552104',
'5911041',
'4411294',
'3265468',
'4604927',
'3761902',
'4092740',
'5762053',
'4256572',
'4800301',
'3042183',
'5550781',
'4441765',
'4340367',
'5963806',
'4563537',
'4770529',
'5856577',
'5546211',
'4719391',
'3265787',
'3593518',
'4064023',
'6141701',
'4186308',
'3563301',
'3673829',
'6119108',
'5704342',
'5670164',
'4300436',
'3240011',
'3170680',
'4806858',
'3671351',
'6217339',
'3081573',
'4441765',
'3557378',
'3349169',
'3506250',
'3807730',
'5888172',
'4585335',
'3372047',
'6147162',
'5911070',
'3309080',
'4299895',
'5685616',
'5518382',
'5801950',
'5612787',
'6080681',
'6178833',
'4158861',
'4197346',
'6344193',
'4392061',
'3335444',
'5396081',
'3111894',
'5878876',
'4184498',
'4207969',
'6212873',
'5659176',
'5924129',
'3782132',
'4729968',
'3165261',
'6366145',
'4245568',
'5600911',
'5967176',
'4620091',
'3082108',
'4736623',
'3020766',
'4249258',
'6178727',
'6365807',
'6364135',
'6365813',
'3864071',
'3143192',
'6382404',
'3685365',
'3482071',
'6134515',
'6269715',
'4360109',
'4630944',
'4311492',
'4375251',
'5266017',
'6052582',
'3699562',
'4260499',
'6072674',
'6083507',
'5965613',
'5864110',
'5704342',
'5735887',
'5259353',
'3207376',
'5620008',
'5649935',
'5823508',
'3613190',
'3154350',
'4378143',
'5796227',
'5533733',
'6133122',
'5991633',
'4441765',
'5535728',
'6055857',
'5708496',
'4562016',
'4607992',
'4166146',
'5553883',
'3596891',
'6218089',
'5789195',
'6202139',
'5992687',
'3207376',
'4581874',
'3685445',
'5271677',
'6119923',
'3568094',
'5888172',
'3015036',
'3345682',
'5991890',
'5680070',
'3840991',
'3589183',
'3245818',
'6275799',
'4539810',
'4266927',
'6107031',
'5620008',
'3141544',
'4581874',
'4181856',
'5361272',
'3490879',
'3318422',
'6422830',
'4769056',
'3940470',
'3792993',
'3368872',
'6186174',
'3737621',
'3109137',
'6227452',
'3024695',
'4271976',
'4147110',
'4238701',
'5828947',
'5296793',
'5272696',
'5335270',
'3292125',
'4238562',
'4127954',
'5869010',
'4443180',
'3591262',
'6361259',
'5491604',
'6256095',
'4804057',
'5762002',
'5592117',
'5923768',
'5508311',
'6338565',
'4441765',
'5535384',
'6235389',
'3716647',
'5910794',
'4328129',
'5891101',
'6075827',
'6193317',
'3576306',
'5483422',
'6021117',
'3601706',
'6054591',
'5559509',
'6453317',
'4214720',
'5379587',
'6460660',
'5262055',
'5803194',
'3630544',
'3802267',
'5779784',
'5621777',
'4796886',
'5831490',
'6061068',
'6353248',
'5393075',
'3485391',
'5616802',
'5620474',
'5615823',
'5881143',
'5672417',
'6344868',
'5707435',
'6008189',
'5763909',
'4645502',
'4092961',
'3705678',
'6072372',
'6399691',
'3590635',
'5615828',
'3311366',
'4236611',
'5888172',
'5910053',
'3581785',
'4748584',
'5674239',
'4783417',
'4356594',
'4473274',
'4279022',
'5935468',
'5650251',
'5578509',
'6381724',
'5988658',
'5674685',
'5308440',
'4586290',
'3796759',
'3147427',
'3242249',
'5910362',
'5645732',
'5861012',
'4719602',
'5911070',
'5787278',
'5801950',
'6409448',
'6227260',
'6294936',
'6207655',
'5691506',
'5630525',
'5562459',
'4357052',
'5908282',
'6357910',
'3427253',
'4255607',
'3896207',
'3231269',
'6063057',
'5666236',
'3364562',
'5549034',
'3646015',
'4283973',
'6414026',
'5554537',
'3556414',
'6058513',
'6094494',
'4152810',
'3739563',
'3822089',
'3614752',
'3862657',
'5793193',
'5668543',
'6254185',
'4234904',
'6432174',
'5391531',
'5949778',
'3551911',
'3484281',
'5864110',
'6104127',
'3328449',
'6490957',
'4238701',
'5974423',
'4274362',
'4366066',
'5372278',
'4144601',
'3509293',
'3081573',
'3057338',
'3113479',
'5798380',
'6075425',
'5695323',
'3614752',
'4760717',
'6654250',
'5589965',
'5889024',
'3785218',
'3050529',
'6674361',
'5547955',
'3854548',
'5276784',
'4793090',
'5972007',
'3862005',
'4340367',
'4098690',
'6103210',
'3062418',
'6229061',
'5569437',
'4558799',
'6361699',
'5765610',
'4240436',
'6490957',
'5553883',
'3686496',
'3372996',
'4138206',
'4597473',
'6123179',
'6075438',
'3123510',
'3829183',
'3043532',
'6380720',
'5669454',
'6131743',
'4767262',
'6007472',
'6323908',
'5705413',
'6729537',
'6732752',
'6068938',
'5708492',
'5362596',
'5881057',
'4619844',
'5709925',
'6361259',
'5652168',
'5967464',
'3042253',
'5546494',
'6423057',
'5564004',
'6130267',
'6219352',
'3604559',
'3685555',
'6407322',
'5700093',
'5967472',
'6492213',
'5640109',
'5578509',
'3076672',
'6075425',
'5395482',
'4276321',
'5774573',
'6535245',
'3345682',
'4438847',
'6535245',
'5819315',
'5544365',
'3929460',
'6383431',
'5905646',
'4291446',
'5678593',
'5765908',
'5888172',
'5983212',
'4376606',
'6073882',
'6405833',
'6080935',
'4736674',
'4771579',
'5281278',
'5516877',
'5915001',
'6689296',
'5949646',
'6176662',
'6001794',
'3050529',
'3408495',
'4563537',
'6127301',
'3372047',
'6512254',
'4189686',
'5625404',
'6602199',
'3684450',
'3552292',
'3020265',
'4245791',
'6535245',
'6383338',
'5544657',
'4785741',
'5377693',
'5538067',
'6405833',
'5258234',
'3104253',
'3826804',
'6052736',
'3880696',
'6777817',
'4723407',
'5508291',
'6258809',
'5768381',
'4087127',
'3814559',
'3341906',
'3894150',
'6059152',
'4739409',
'4181856',
'4583559',
'5787240',
'6437275',
'3355830',
'5514084',
'5940786',
'6176662',
'6804849',
'3311366',
'3862657',
'3060449',
'6073882',
'3754782',
'5535284',
'5880975',
'5777867',
'6435561')
group by 1 
order by 2 desc 